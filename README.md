# FriendSearchService

- [FriendSearchService](#friendsearchservice)
    - [Описание](#описание)
        - [Список маршрутов](#список-маршрутов)
        - [OpenAPI schema](#openapi-schema)
        - [Регистрация](#регистрация)
        - [Авторизация через браузер](#авторизация-через-браузер)
        - [Авторизация (получение токена)](#авторизация-получение-токена)
    - [Использование сервиса](#использование-сервиса)
        - [Клонирование текущего репозитория](#клонирование-текущего-репозитория)
        - [Быстрый запуск (с помощью Docker)](#быстрый-запуск-с-помощью-docker)
        - [Установка зависимостей](#установка-зависимостей)
        - [Запуск проекта](#запуск-проекта)
    - [Примеры использования API](#примеры-использования-api)
        - [Получение текущего пользователя](#получение-текущего-пользователя)
        - [Получить всех пользователей](#получить-всех-пользователей)
        - [Получить конкретного пользователя](#получить-конкретного-пользователя)
        - [Отправить заявку в друзья](#отправить-заявку-в-друзья)
        - [Получить статус дружбы с другим пользователем](#получить-статус-дружбы-с-другим-пользователем)
        - [Посмотреть список исходящих заявок](#посмотреть-список-исходящих-заявок)
        - [Посмотреть список входящих заявок](#посмотреть-список-входящих-заявок)
        - [Принять заявку в друзья](#принять-заявку-в-друзья)
        - [Отклонить заявку в друзья](#отклонить-заявку-в-друзья)
        - [Посмотреть список своих друзей](#посмотреть-список-своих-друзей)
        - [Удалить из своих друзей](#удалить-из-своих-друзей)
    - [Разработка](#разработка)
        - [Formatters](#formatters)
        - [Linters](#linters)

## Описание

Данный проект представляет собой сервис (API чаcnm), в котором люди могут добавлять друг друга в друзья. Реализован сервис с помощью Django REST Framework.

Для использования API нужно получить токен. Как получить токен, и где его использовать читайте в разделе [Авторизация (получение токена)](#авторизация-получение-токена).

### Список маршрутов

Для использования API можно использовать Postmen запросы.

| Описание ссылки                               | Метод HTTP | Ссылка                                                                           |
|:--------------------------------------------- |:----------:|:-------------------------------------------------------------------------------- |
| Регистрация нового пользователя               |   `POST`   | `http://127.0.0.1:8000/api/v1/auth/users/`                                       |
| Получение текущего пользователя               |   `GET`    | `http://127.0.0.1:8000/api/v1/auth/users/me`                                     |
| Получить всех пользователей                   |   `GET`    | `http://127.0.0.1:8000/api/v1/people/`                                           |
| Получить конкретного пользователя             |   `GET`    | `http://127.0.0.1:8000/api/v1/people/<int:user_id>/`                             |
| Отправить пользователю заявку в друзья        |   `POST`   | `http://127.0.0.1:8000/api/v1/people/<int:user_id>/send_friend_requests`         |
| Получить статус дружбы с другим пользователем |   `GET`    | `http://127.0.0.1:8000/api/v1/friend_request/<int:user_id>/check_status`         |
| Посмотреть список исходящих заявок            |   `GET`    | `http://127.0.0.1:8000/api/v1/friend_request/submitted_requests`                 |
| Посмотреть список входящих заявок             |   `GET`    | `http://127.0.0.1:8000/api/v1/friend_request/incoming_requests`                  |
| Принять заявку в друзья от пользователя       |   `POST`   | `http://127.0.0.1:8000/api/v1/friend_request/<int:user_id>/accept`               |
| Отклонить заявку в друзья от пользователя     |   `POST`   | `http://127.0.0.1:8000/api/v1/friend_request/<int:user_id>/reject`               |
| Посмотреть список своих друзей                |   `GET`    | `http://127.0.0.1:8000/api/v1/friends/`                                          |
| Удалить пользователя из своих друзей          |  `DELETE`  | `http://127.0.0.1:8000/api/v1/friends/<int:user_id>/delete`                      |

### OpenAPI schema

Для генерации `openapi-schema.yaml` использовалась команда:

```shell
poetry run python FriendSearchService/manage.py generateschema --file openapi-schema.yml
```

В результате появляется файл, в котором полностью описывается API сервиса.

### Регистрация

Для регистрации надо отправить `POST` запрос по адресу:

```url
http://127.0.0.1:8000/api/v1/auth/users/
```

В теле запроса надо указать:

```json
{
    "username": "your_username",
    "password": "your_password"
}
```

Опционально можно указать электронную почту:

```json
{
    "username": "your_username",
    "password": "your_password",
    "email": "your_email"
}
```

В случае успеха получите ответ со статусом `201` со следующим содержимым:

```json
{
    "email": "",
    "username": "test_user10",
    "id": 10
}
```

### Авторизация через браузер

Можно использовать функционал, который предоставляет Django REST Framework. Перейдите по ссылке `http://127.0.0.1:8000/api/v1/session_auth/login/`.

В появившейся форме введите логин и пароль пользователя. После этого вы сможете использовать API сайта в браузере.

### Авторизация (получение токена)

Для использования API надо авторизоваться через токен. Для этого надо послать `POST` запрос по адресу:

```url
http://127.0.0.1:8000/api/v1/auth/token/login
```

В теле запроса надо указать:

```json
{
    "username": "your_username",
    "password": "your_password"
}
```

В ответ (в случае, если пользователь зарегистрирован) вы получите статус `200` и следующее содержимое:

```json
{
    "auth_token": "auth_token"
}
```

- `auth_token` -- токен, с помощью которого можно пользоваться API, без него не будет доступа и будет соответствующая ошибка

Для использования API все запросы надо отправлять с `Headers`, где будет указан ваш токен:

```json
{
    "Authorization": "Token auth_token"
}
```

## Использование сервиса

Дальше в описании будут использоваться команды `make`, которые в одной `make`-команде будут объединять несколько команд. Если у вас не установлен `make`, то не используйте команды для него.

### Клонирование текущего репозитория

```shell
git clone https://github.com/Allozo/FriendSearchService.git
```

### Быстрый запуск (с помощью Docker)

Если у вас установлен Docker, то запустить сервис можно одной командой. Находясь в корне проекта запустите следующую команду:

```shell
docker-compose up --build -d
```

После этого можно переходить по ссылке:

```
http://127.0.0.1:8000/api/v1/session_auth/login/
```

Или можно воспользоваться Postman и теми инструкциями, что указаны в разделе.

### Установка зависимостей

Установить зависимости можно следующей командой:

```shell
make venv
```

или

```shell
python -m pip install --upgrade pip
python -m pip install poetry
poetry install
```

### Запуск проекта

Запустить проект можно командой:

```shell
make up
```

или

```shell
poetry run python FriendSearchService/manage.py runserver
```

## Примеры использования API

Для использования API нужен токен. Как его получить и использовать рассказано подробнее в разделе `Авторизация (получение токена)`. Далее будет подразумеваться, что в `Headers` у вас указан токен.

### Получение текущего пользователя

Для получения текущего пользователя надо отправить `GET` запрос по ссылке:

```url
http://127.0.0.1:8000/api/v1/auth/users/me
```

Если пользователь существует, то ответ будет следующий:

```json
{
    "email": "",
    "id": 1,
    "username": "your_user"
}
```

### Получить всех пользователей

Для получения всех зарегистрированных пользователей надо отправить `GET` запрос по ссылке:

```url
http://127.0.0.1:8000/api/v1/people/
```

Ответ будет следующий:

```json
[
    {
        "id": 1,
        "username": "user_1",
        "email": "user_1@user.ru"
    },
    {
        "id": 2,
        "username": "user_2",
        "email": "user_2@user.ru"
    },
    {
        "id": 3,
        "username": "user_3",
        "email": "user_3@user.ru"
    },
    {
        "id": 4,
        "username": "user_4",
        "email": "user_4@user.ru"
    }
]
```

### Получить конкретного пользователя

Для получения конкретного пользователя надо отправить `GET` запрос по ссылке:

```url
http://127.0.0.1:8000/api/v1/people/<int:user_id>
```

Если пользователь существует, то ответ будет следующий:

```json
{
    "id": <int:user_id>,
    "username": "user_name",
    "email": "user@user.ru"
}
```

### Отправить заявку в друзья

Для отправки заявки в друзья пользователю с `id=<int:user_id>` надо отправить `GET` запрос по ссылке:

```url
http://127.0.0.1:8000/api/v1/people/<int:user_id>/send_friend_requests/
```

Если пользователь существует, то ответ будет следующий:

```json
{
    "to_user": 2,
    "created_at": "2023-05-10T21:06:46.250899+03:00",
    "status": "Заявка отправлена"
}
```

Если данный пользователь уже отправлял вам заявку в друзья, то ваши заявки автоматически примутся и вы станете друзьями.

### Получить статус дружбы с другим пользователем

Для получения информации о том, какой статус дружбы с пользователем `id=<int:user_id>`, надо отправить `GET` запрос по ссылке:

```url
http://127.0.0.1:8000/api/v1/friend_request/<int:user_id>/check_status
```

Если пользователь существует, то ответ будет следующий:

```json
{
    "to_user": <int:user_id>,
    "created_at": "2023-05-10T21:06:46.250899+03:00",
    "status": "<Статус заявки>"
}
```

Возможно несколько видов статусов:

- Заявка отправлена -- вы отправили пользователю, а пользователь ещё никак на неё не отреагировал
- Есть входящая заявка -- данный пользователь отправил вам заявку в друзья
- Заявка отклонена -- данный пользователь отклонил вашу заявку в друзья
- Друзья -- Данный пользователь принял вашу заявку в друзья
- Запрос в друзья ещё не был отправлен -- ни вы, ни данный пользователь не отправляли друг другу заявки в друзья

### Посмотреть список исходящих заявок

Для получения списка исходящих заявок (ещё не принятых/отклонённых) надо отправить `GET` запрос по ссылке:

```url
http://127.0.0.1:8000/api/v1/friend_request/submitted_requests/
```

Ответ будет следующий:

```json
[
    {
        "id": <int:user_id>,
        "username": "user_name_1",
        "email": "user_1@user.ru"
    },
    {
        "id": <int:user_id>,
        "username": "user_name_2",
        "email": "user_2@user.ru"
    }
]
```

### Посмотреть список входящих заявок

Для получения списка входящих заявок надо отправить `GET` запрос по ссылке:

```url
http://127.0.0.1:8000/api/v1/friend_request/incoming_requests/
```

Ответ будет следующий:

```json
[
    {
        "id": <int:user_id>,
        "username": "user_name_1",
        "email": "user_1@user.ru"
    },
    {
        "id": <int:user_id>,
        "username": "user_name_2",
        "email": "user_2@user.ru"
    }
]
```

### Принять заявку в друзья

Для того, чтобы принять заявку в друзья от другого пользователя должна быть одна из следующих ситуаций:

- другой пользователь отправил нам запрос в друзья, и мы его принимаем
- другой пользователь отправил нам запрос в друзья, мы его отклонили раньше, а потом приняли

Для приёма заявки отправляем `GET` запрос по адресу:

```url
http://127.0.0.1:8000/api/v1/friend_request/<int:user_id>/accept/
```

В случае успеха, будет статус `200` c содержимым:

```json
{
    "user": "<int:user_id>",
    "status": "Друзья"
}
```

### Отклонить заявку в друзья

Для того, чтобы отклонить заявку в друзья надо отправить `POST` запрос по адресу:

```url
http://127.0.0.1:8000/api/v1/friend_request/<int:user_id>/reject/
```

В случае успеха, будет статус `200` с содержимым:

```json
{
    "user": "<int:user_id>",
    "status": "Заявка отклонена"
}
```

### Посмотреть список своих друзей

Для получения списка друзей надо отправить `GET` запрос по ссылке:

```url
http://127.0.0.1:8000/api/v1/friends/
```

Ответ будет следующий:

```json
[
    {
        "user": <int:user_id>,
        "created_at": "2023-05-10T21:33:06.580923+03:00",
        "status": "Друзья"
    },
    {
        "user": <int:user_id>,
        "created_at": "2023-05-10T21:33:06.580923+03:00",
        "status": "Друзья"
    },
]
```

### Удалить из своих друзей

Для того, чтобы удалить человека из друзей надо отправить `POST` запрос по адресу:

```url
http://127.0.0.1:8000/api/v1/friends/<int:user_id>/delete/
```

В случае успеха, будет статус `200` с содержимым:

```json
{
    "to_user": 2,
    "created_at": "2023-05-10T21:33:06.580923+03:00",
    "status": "Заявка отклонена"
}
```

При этом его заявка изменится на "Заявка отправлена", но не будет отображаться в списках отправленных заявок, так как вы её отклонили.

Это можно проверить явно проверив статус дружбы с пользователем.

## Разработка

### Formatters

Для запуска форматеров можно воспользоваться командой:

```shell
make format
```

или

```shell
poetry run python -m isort tests FriendSearchService
poetry run python -m black --skip-string-normalization tests FriendSearchService
poetry run python -m autoflake --recursive --in-place --remove-all-unused-imports tests FriendSearchService
```

### Linters

Для запуска линтеров можно воспользоваться командой:

```shell
make lint
```

или

```shell
poetry run python -m flake8 --jobs 4 --statistics --show-source tests FriendSearchService
poetry run python -m pylint --jobs 4 --rcfile=setup.cfg tests FriendSearchService
poetry run python -m mypy --install-types tests FriendSearchService
poetry run python -m black --skip-string-normalization --check tests FriendSearchService
```
